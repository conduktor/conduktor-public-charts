{{- if .Values.tests.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: "test-kafka-config"
  annotations:
    helm.sh/hook: pre-install
    helm.sh/hook-weight: "-99"
data:
  server.properties: |-
    advertised.listeners=CLIENT://advertised-address-placeholder:9092,INTERNAL://advertised-address-placeholder:9094
    controller.listener.names=CONTROLLER
    controller.quorum.bootstrap.servers=advertised-address-placeholder:9093
    inter.broker.listener.name=INTERNAL
    listener.name.client.plain.sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required user_kafka-admin="kafka-admin-password";
    listener.name.client.scram-sha-256.sasl.jaas.config=org.apache.kafka.common.security.scram.ScramLoginModule required;
    listener.name.client.scram-sha-512.sasl.jaas.config=org.apache.kafka.common.security.scram.ScramLoginModule required;
    listener.name.internal.plain.sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username="inter_broker_user" password="interbroker-password-placeholder" user_inter_broker_user="interbroker-password-placeholder" user_kafka-admin="password-placeholder-0";
    listener.name.internal.scram-sha-256.sasl.jaas.config=org.apache.kafka.common.security.scram.ScramLoginModule required username="inter_broker_user" password="interbroker-password-placeholder";
    listener.name.internal.scram-sha-512.sasl.jaas.config=org.apache.kafka.common.security.scram.ScramLoginModule required username="inter_broker_user" password="interbroker-password-placeholder";
    listener.security.protocol.map=CLIENT:SASL_PLAINTEXT,INTERNAL:SASL_PLAINTEXT,CONTROLLER:PLAINTEXT
    listeners=CLIENT://:9092,INTERNAL://:9094,CONTROLLER://:9093
    log.dir=/bitnami/kafka/data
    logs.dir=/opt/bitnami/kafka/logs
    process.roles=controller,broker
    sasl.enabled.mechanisms=PLAIN,SCRAM-SHA-256,SCRAM-SHA-512
    sasl.mechanism.inter.broker.protocol=PLAIN
    default.replication.factor=1
    offsets.topic.replication.factor=1
    transaction.state.log.replication.factor=1
---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: kafka
  annotations:
    helm.sh/hook: pre-install
    helm.sh/hook-weight: "-99"
spec:
  repo: https://charts.bitnami.com/bitnami
  chart: kafka
  version: 32.1.2
  set:
    clusterId: "test"
    image.debug: "false"
    existingConfigmap: "test-kafka-config"
    sasl.client.users[0]: "kafka-admin"
    sasl.client.passwords[0]: "kafka-admin-password"
    controller.replicaCount: "1"
    controller.persistence.size: 1Gi
    controller.resources.requests.cpu: "100m"
    controller.resources.requests.memory: "512Mi"
    controller.resources.limits.cpu: "750m"
    controller.resources.limits.memory: "2Gi"
{{- if .Values.tests.console.enabled }}
---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: main-postgresql
  annotations:
    helm.sh/hook: pre-install
    helm.sh/hook-weight: "-99"
spec:
  repo: https://charts.bitnami.com/bitnami
  chart: postgresql
  version: 16.6.0
  set:
    auth.postgresPassword: "conduktor123"
    primary.persistence.size: 1Gi
    volumePermissions.enabled: "true"
---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: console
  annotations:
    helm.sh/hook: pre-install
    helm.sh/hook-weight: "-50"
spec:
  repo: https://helm.conduktor.io
  chart: console
  set:
    config.admin.email: "test@test.io"
    config.admin.password: "testP4ss!"
    config.database.host: "main-postgresql"
    config.database.port: 5432
    config.database.name: "postgres"
    config.database.username: "postgres"
    config.database.password: "conduktor123"
    config.clusters[0].id: "kafka"
    config.clusters[0].name: "Kafka"
    config.clusters[0].bootstrapServers: "kafka:9092"
    config.clusters[0].properties: "sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username='kafka-admin' password='kafka-admin-password';\nsasl.mechanism=PLAIN\nsecurity.protocol=SASL_PLAINTEXT"
{{- end }}
{{- if .Values.tests.gateway.enabled }}
---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: gateway
  annotations:
    helm.sh/hook: pre-install
    helm.sh/hook-weight: "-75"
spec:
  repo: https://helm.conduktor.io
  chart: conduktor-gateway
  version: 3.8.0
  set:
    gateway.replicas: 1
    gateway.env.KAFKA_BOOTSTRAP_SERVERS: "kafka:9092"
    gateway.env.KAFKA_SECURITY_PROTOCOL: "SASL_PLAINTEXT"
    gateway.env.KAFKA_SASL_MECHANISM: "PLAIN"
    gateway.env.KAFKA_SASL_JAAS_CONFIG: "org.apache.kafka.common.security.plain.PlainLoginModule required username='kafka-admin' password='kafka-admin-password';"
    gateway.env.GATEWAY_SECURITY_MODE: "GATEWAY_MANAGED"
    gateway.env.GATEWAY_SECURITY_PROTOCOL: "SASL_PLAINTEXT"
    gateway.env.GATEWAY_ACL_ENABLED: "\"true\""
    gateway.env.GATEWAY_SUPER_USERS: "admin"
    gateway.admin.users[0].username: "admin"
    gateway.admin.users[0].password: "Admin123!"
    gateway.admin.users[0].admin: "true"
    gateway.startupProbe.initialDelaySeconds: 60
{{- end }}
{{- end }}